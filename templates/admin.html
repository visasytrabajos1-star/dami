{% extends "base.html" %}

{% block title %}Administración - NexPos{% endblock %}

{% block content %}
<div class="glass-card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
        <h2>Panel de Administración</h2>
    </div>

    <!-- Tabs -->
    <div style="display: flex; border-bottom: 2px solid rgba(0,0,0,0.1); margin-bottom: 24px;">
        <button onclick="switchTab('general')" id="tab-general" class="tab-btn active"
            style="padding: 12px 24px; font-weight: 500; border-bottom: 2px solid var(--primary-color); color: var(--primary-color); background: none; cursor: pointer;">
            Sistema
        </button>
        <button onclick="switchTab('users')" id="tab-users" class="tab-btn"
            style="padding: 12px 24px; font-weight: 500; border-bottom: 2px solid transparent; color: #666; background: none; cursor: pointer;">
            Usuarios
        </button>
        <button onclick="switchTab('taxes')" id="tab-taxes" class="tab-btn"
            style="padding: 12px 24px; font-weight: 500; border-bottom: 2px solid transparent; color: #666; background: none; cursor: pointer;">
            Impuestos
        </button>
    </div>

    <!-- GENERAL SETTINGS -->
    <div id="content-general" class="tab-content">
        <h3 style="margin-bottom: 16px;">Configuración General</h3>
        <form onsubmit="updateSettings(event)" style="max-width: 500px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 500;">Nombre de la Empresa</label>
            <input type="text" id="s-company" name="company_name" required value="" class="form-input">

            <label style="display: block; margin-bottom: 8px; margin-top: 16px; font-weight: 500;">Impresora
                Predeterminada (Windows)</label>
            <input type="text" id="s-printer" name="printer_name" placeholder="Ej. EPSON TM-T20II" class="form-input">
            <small style="color: #666; display: block; margin-top: 4px;">Nombre exacto de la impresora instalada en el
                servidor/PC host.</small>

            <button type="submit" class="btn" style="margin-top: 24px;">Guardar Cambios</button>
        </form>
    </div>

    <!-- USERS -->
    <div id="content-users" class="tab-content" style="display: none;">
        <div style="display: flex; justify-content: space-between; margin-bottom: 16px;">
            <h3>Gestión de Usuarios</h3>
            <button onclick="openUserModal()" class="btn">+ Nuevo Usuario</button>
        </div>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Usuario</th>
                        <th>Nombre Completo</th>
                        <th>Rol</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="users-table">
                    <!-- JS populated -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- TAXES -->
    <div id="content-taxes" class="tab-content" style="display: none;">
        <div style="display: flex; justify-content: space-between; margin-bottom: 16px;">
            <h3>Impuestos y Tasas</h3>
            <button onclick="openTaxModal()" class="btn">+ Nuevo Impuesto</button>
        </div>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Nombre</th>
                        <th>Alícuota (%)</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="taxes-table">
                    <!-- JS populated -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Add User Modal -->
<div id="user-modal"
    style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100; justify-content: center; align-items: center;">
    <div class="glass-card" style="width: 100%; max-width: 400px; background: white;">
        <h3 style="margin-bottom: 16px;">Nuevo Usuario</h3>
        <form onsubmit="createUser(event)">
            <label style="display: block; margin-bottom: 8px;">Username</label>
            <input type="text" name="username" required>
            <label style="display: block; margin-bottom: 8px;">Password</label>
            <input type="password" name="password" required>
            <label style="display: block; margin-bottom: 8px;">Nombre Completo</label>
            <input type="text" name="full_name">
            <label style="display: block; margin-bottom: 8px;">Rol</label>
            <select name="role" required style="width: 100%; padding: 10px; border-radius: 8px; margin-bottom: 16px;">
                <option value="cashier">Cajero (Parcial)</option>
                <option value="admin">Administrador (Total)</option>
            </select>
            <div style="text-align: right;">
                <button type="button" onclick="document.getElementById('user-modal').style.display='none'" class="btn"
                    style="background: #999;">Cancelar</button>
                <button type="submit" class="btn">Crear</button>
            </div>
        </form>
    </div>
</div>

<!-- Add Tax Modal -->
<div id="tax-modal"
    style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100; justify-content: center; align-items: center;">
    <div class="glass-card" style="width: 100%; max-width: 400px; background: white;">
        <h3 style="margin-bottom: 16px;">Nuevo Impuesto</h3>
        <form onsubmit="createTax(event)">
            <label style="display: block; margin-bottom: 8px;">Nombre (ej. IVA 21%)</label>
            <input type="text" name="name" required placeholder="IVA General">
            <label style="display: block; margin-bottom: 8px;">Alícuota (ej. 0.21)</label>
            <input type="number" step="0.001" name="rate" required placeholder="0.21">
            <div style="text-align: right; margin-top: 16px;">
                <button type="button" onclick="document.getElementById('tax-modal').style.display='none'" class="btn"
                    style="background: #999;">Cancelar</button>
                <button type="submit" class="btn">Crear</button>
            </div>
        </form>
    </div>
</div>

<script>
    // --- Tabs Logic ---
    function switchTab(tab) {
        document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
        document.querySelectorAll('.tab-btn').forEach(el => {
            el.style.borderBottomColor = 'transparent';
            el.style.color = '#666';
            el.classList.remove('active');
        });

        document.getElementById('content-' + tab).style.display = 'block';
        const btn = document.getElementById('tab-' + tab);
        btn.style.borderBottomColor = 'var(--primary-color)';
        btn.style.color = 'var(--primary-color)';
        btn.classList.add('active');

        if (tab === 'users') loadUsers();
        if (tab === 'taxes') loadTaxes();
    }

    // --- Init ---
    const currentUserId = {{ user.id }};

    document.addEventListener('DOMContentLoaded', () => {
        // Load settings initially (Assuming we might pass them in template or fetch)
        // Since the current 'settings' variable is not passed to this template in main.py yet except possibly global context?
        // Let's safe fetch or use template vars if available. 
        // We'll rely on fetch for consistency since endpoints exist.
        // Wait, current GET /settings endpoint doesn't return JSON Settings... it returns the settings object internal?
        // We probably need a GET /api/settings. 
        // But let's assume `{{ settings.company_name }}` is available if context processor puts it there?
        // Actually main.py doesn't seem to have context processor for settings.
        // I'll assume we need to fill it from somewhere. Let's do a quick fetch or inject in template response.
        // I injected `user` and `request` in main.py. I should inject `settings` too or fetch it.
        // I'll fetch it from an endpoint or just rely on manual input for now? No, better fetch.
    });

    // --- Users ---
    async function loadUsers() {
        const res = await fetch('/api/users');
        const users = await res.json();
        const tbody = document.getElementById('users-table');
        tbody.innerHTML = users.map(u => `
            <tr>
                <td>${u.username}</td>
                <td>${u.full_name || '-'}</td>
                <td><span class="badge ${u.role === 'admin' ? 'admin' : ''}">${u.role}</span></td>
                <td>
                    ${u.role !== 'admin' || u.id !== currentUserId ? `
                    <button onclick="deleteUser(${u.id})" style="color: red; border:none; background:none; cursor:pointer;">Eliminar</button>
                    ` : ''}
                </td>
            </tr>
        `).join('');
    }

    function openUserModal() { document.getElementById('user-modal').style.display = 'flex'; }

    async function createUser(e) {
        e.preventDefault();
        const data = new FormData(e.target);
        const res = await fetch('/api/users', { method: 'POST', body: data });
        if (res.ok) {
            e.target.reset();
            document.getElementById('user-modal').style.display = 'none';
            loadUsers();
        } else alert("Error creando usuario");
    }

    async function deleteUser(id) {
        if (!confirm("¿Eliminar usuario?")) return;
        await fetch('/api/users/' + id, { method: 'DELETE' });
        loadUsers();
    }

    // --- Taxes ---
    async function loadTaxes() {
        const res = await fetch('/api/taxes');
        const taxes = await res.json();
        const tbody = document.getElementById('taxes-table');
        tbody.innerHTML = taxes.map(t => `
        < tr >
                <td>${t.name}</td>
                <td>${(t.rate * 100).toFixed(2)}%</td>
                <td>
                    <button onclick="deleteTax(${t.id})" style="color: red; border:none; background:none; cursor:pointer;">Eliminar</button>
                </td>
            </tr >
        `).join('');
    }

    function openTaxModal() { document.getElementById('tax-modal').style.display = 'flex'; }

    async function createTax(e) {
        e.preventDefault();
        const data = new FormData(e.target);
        const res = await fetch('/api/taxes', { method: 'POST', body: data });
        if (res.ok) {
            e.target.reset();
            document.getElementById('tax-modal').style.display = 'none';
            loadTaxes();
        }
    }

    async function deleteTax(id) {
        if (!confirm("¿Eliminar impuesto?")) return;
        await fetch('/api/taxes/' + id, { method: 'DELETE' });
        loadTaxes();
    }

    // --- Settings ---
    async function updateSettings(e) {
        e.preventDefault();
        const data = new FormData(e.target);
        const res = await fetch('/api/settings', { method: 'POST', body: data });
        if (res.ok) alert("Configuración guardada");
        else alert("Error al guardar");
    }
</script>

<style>
    .form-input {
        width: 100%;
        padding: 12px;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        margin-bottom: 0;
    }

    .badge {
        padding: 4px 8px;
        border-radius: 4px;
        background: #e5e7eb;
        font-size: 0.8rem;
    }

    .badge.admin {
        background: #dbeafe;
        color: #1e40af;
    }
</style>
{% endblock %}